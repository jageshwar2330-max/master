name: security-and-quality-scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  full_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        python -m pip install --upgrade pip
        pip install bandit semgrep flake8 pylint detect-secrets

    - name: Run Bandit
      run: bandit -r . -f json -o bandit.json || true

    - name: Run Semgrep
      run: semgrep --config=p/ci --json --output semgrep.json || true

    - name: Run Flake8
      run: flake8 --format=json > flake8.json || true

    - name: Run Pylint
      run: pylint **/*.py --output-format=json > pylint.json || true

    - name: Run Detect-Secrets
      run: detect-secrets scan > secrets.json || true

    - name: Generate combined JSON report
      run: |
        jq -n \
          --slurpfile bandit bandit.json \
          --slurpfile semgrep semgrep.json \
          --slurpfile flake8 flake8.json \
          --slurpfile pylint pylint.json \
          --slurpfile secrets secrets.json \
          '{
            bandit: $bandit[0].results // [],
            semgrep: $semgrep[0].results // [],
            flake8: $flake8[0] // [],
            pylint: $pylint[0] // [],
            secrets: ($secrets[0].results // [])
          }' > combined.json

    - name: Generate human-readable error log
      continue-on-error: true
      run: |
        echo "File (Line) | Issue | Suggested Fix" > error.log
        echo "------------|-------|--------------" >> error.log

        [ -s bandit.json ] && jq -r '.results[] |
          "\(.filename):\(.line_number) | ðŸ”´ Security | Remove hardcoded secret"' bandit.json >> error.log

        [ -s semgrep.json ] && jq -r '.results[] |
          "\(.path):\(.start.line) | ðŸŸ¡ Semgrep | Fix rule \(.check_id)"' semgrep.json >> error.log

        [ -s flake8.json ] && jq -r '.[] |
          "\(.filename):\(.line_number) | ðŸŸ¢ Style | Fix \(.code)"' flake8.json >> error.log

        [ -s pylint.json ] && jq -r '.[] |
          "\(.path):\(.line) | ðŸŸ¢ Pylint | Fix \(.symbol)"' pylint.json >> error.log

        [ -s secrets.json ] && jq -r '.results | to_entries[] |
          "\(.value.filename):\(.value.line_number) | ðŸ”´ Secret | Secure or remove"' secrets.json >> error.log

    - name: Upload JSON report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-quality-json-report
        path: combined.json

    - name: Upload error log
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-quality-error-log
        path: error.log

    - name: Post PR summary comment
      if: always()
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          âœ… Security & Quality Scan completed  
          ðŸ“Ž Artifacts uploaded:
          - combined.json  
          - error.log
