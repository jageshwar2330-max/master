name: security-and-quality-scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  full_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: jageshwar2330-max/security-and-quality-scan.yml@v1.0.0

    - name: Set up Python
      uses: jageshwar2330-max/security-and-quality-scan.yml@v1.0.0

    - name: Install tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit semgrep flake8 pylint detect-secrets jq

    - name: Run Bandit (security)
      run: bandit -r . -f json -o bandit.json

    - name: Run Semgrep (security & anti-patterns)
      run: semgrep --config=p/ci --json --output semgrep.json

    - name: Run Flake8 (style & formatting)
      run: flake8 --format=json > flake8.json || true

    - name: Run Pylint (best practices / code smells)
      run: pylint **/*.py --output-format=json > pylint.json || true

    - name: Run Detect-Secrets (hardcoded secrets)
      run: detect-secrets scan > secrets.json

    - name: Generate JSON summary
      run: |
        jq -n --slurpfile bandit bandit.json \
          --slurpfile semgrep semgrep.json \
          --slurpfile flake8 flake8.json \
          --slurpfile pylint pylint.json \
          --slurpfile secrets secrets.json \
          '
          {
            bandit: $bandit[0].results // [],
            semgrep: $semgrep[0].results // [],
            flake8: $flak8[0] // [],
            pylint: $pylint[0] // [],
            secrets: $secrets[0].results // []
          }' > combined.json

    - name: Upload JSON report
      uses: actions/upload-artifact@v3
      with:
        name: security-quality-json-report
        path: combined.json

    - name: Generate human-readable error log
      run: |
        echo "File Name (Line) | Potential Issue | Suggested Fix" > error.log
        echo "-----------------|----------------|----------------" >> error.log

        if [ -s bandit.json ]; then
          jq -r '.results[] | "\(.filename):\(.line_number) | ðŸ”´ Hardcoded secret / Security issue | Remove hardcoded secret or use secret manager"' bandit.json >> error.log 2>/dev/null
        fi

        if [ -s semgrep.json ]; then
          jq -r '.results[] | "\(.path):\(.start.line) | ðŸŸ¡ Potential anti-pattern / Security | Fix according to Semgrep rule \(.check_id)"' semgrep.json >> error.log 2>/dev/null
        fi

        if [ -s flake8.json ]; then
          jq -r '.[] | "\(.filename):\(.line_number) | ðŸŸ¢ Style / formatting | Fix E or W code \(.code)"' flake8.json >> error.log 2>/dev/null
        fi

        if [ -s pylint.json ]; then
          jq -r '.[] | "\(.path):\(.line) | ðŸŸ¢ Best practice / Code smell | Fix issue \(.symbol)"' pylint.json >> error.log 2>/dev/null
        fi

        if [ -s secrets.json ]; then
          jq -r '.results | to_entries[] | "\(.value.filename):\(.value.line_number) | ðŸ”´ Hardcoded secret | Remove or secure secret"' secrets.json >> error.log 2>/dev/null
        fi
      shell: bash

    - name: Upload error log
      uses: actions/upload-artifact@v3
      with:
        name: security-quality-error-log
        path: error.log

    - name: Post PR summary comment
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ### Security & Quality Scan Summary
          See attached report artifacts for full details.
