name: Security & Quality Factory Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  factory:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        python -m pip install --upgrade pip
        pip install bandit semgrep flake8 pylint detect-secrets

    # ðŸ¤– Bandit
    - name: Bandit Scan
      run: bandit -r . -f json -o bandit.json || true

    # ðŸ¤– Semgrep
    - name: Semgrep Scan
      run: semgrep --config=p/ci --json --output semgrep.json || true

    # ðŸ¤– Flake8
    - name: Flake8 Scan
      run: flake8 --format=json > flake8.json || true

    # ðŸ¤– Pylint
    - name: Pylint Scan
      run: pylint **/*.py --output-format=json > pylint.json || true

    # ðŸ¤– Detect-Secrets
    - name: Detect-Secrets Scan
      run: detect-secrets scan > secrets.json || true

    # ðŸ§  Aggregator (safe jq + code line)
    - name: Generate error log
      continue-on-error: true
      run: |
        echo "File (Line) | Issue | Suggested Fix | Code" > error.log
        echo "------------|-------|---------------|------" >> error.log

        extract_code() {
          file=$1
          line=$2
          sed -n "${line}p" "$file" 2>/dev/null | sed 's/|/ /g'
        }

        # ðŸ”´ Bandit
        if jq -e . bandit.json >/dev/null 2>&1; then
          jq -r '.results[] |
            "\(.filename)|\(.line_number)|Security|Remove hardcoded secret"' bandit.json |
          while IFS="|" read file line issue fix; do
            code=$(extract_code "$file" "$line")
            echo "$file:$line | ðŸ”´ $issue | $fix | $code" >> error.log
          done
        fi

        # ðŸŸ¡ Semgrep
        if jq -e . semgrep.json >/dev/null 2>&1; then
          jq -r '.results[] |
            "\(.path)|\(.start.line)|Semgrep|Fix rule \(.check_id)"' semgrep.json |
          while IFS="|" read file line issue fix; do
            code=$(extract_code "$file" "$line")
            echo "$file:$line | ðŸŸ¡ $issue | $fix | $code" >> error.log
          done
        fi

        # ðŸŸ¢ Flake8
        if jq -e . flake8.json >/dev/null 2>&1; then
          jq -r '.[] |
            "\(.filename)|\(.line_number)|Flake8|Fix \(.code)"' flake8.json |
          while IFS="|" read file line issue fix; do
            code=$(extract_code "$file" "$line")
            echo "$file:$line | ðŸŸ¢ $issue | $fix | $code" >> error.log
          done
        fi

        # ðŸŸ¢ Pylint
        if jq -e . pylint.json >/dev/null 2>&1; then
          jq -r '.[] |
            "\(.path)|\(.line)|Pylint|Fix \(.symbol)"' pylint.json |
          while IFS="|" read file line issue fix; do
            code=$(extract_code "$file" "$line")
            echo "$file:$line | ðŸŸ¢ $issue | $fix | $code" >> error.log
          done
        fi

        # ðŸ”´ Detect-Secrets
        if jq -e . secrets.json >/dev/null 2>&1; then
          jq -r '.results | to_entries[] |
            "\(.value.filename)|\(.value.line_number)|Secret|Secure or remove"' secrets.json |
          while IFS="|" read file line issue fix; do
            code=$(extract_code "$file" "$line")
            echo "$file:$line | ðŸ”´ $issue | $fix | $code" >> error.log
          done
        fi

    - name: Upload error log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-quality-error-log
        path: error.log
