name: Security, Quality & Optimization Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  full_scan:
    name: Full Code Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------
      # Python Setup
      # ------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install tools
        run: |
          pip install --upgrade pip
          pip install \
            bandit \
            semgrep \
            black \
            isort \
            flake8 \
            pylint \
            detect-secrets

      # ------------------------
      # Formatting & style
      # ------------------------
      - name: Black
        run: black --check .

      - name: isort
        run: isort --check-only .

      - name: Flake8
        run: flake8 . --max-line-length=100 --max-complexity=10

      - name: Pylint (quality + performance)
        run: |
          pylint $(find . -name "*.py" -not -path "./.venv/*") \
            --fail-under=8.0 \
            --enable=consider-using-generator,consider-using-with

      # ------------------------
      # Hardcoded secrets
      # ------------------------
      - name: Detect hardcoded secrets
        run: |
          detect-secrets scan > secrets-report.json
          if jq '.results | length > 0' secrets-report.json; then
            echo "❌ Hardcoded secrets detected"
            exit 1
          fi

      # ------------------------
      # Security
      # ------------------------
      - name: Bandit
        run: |
          bandit -r . -ll -iii

      # ------------------------
      # Semgrep – security + hardcoding + optimization
      # ------------------------
      - name: Semgrep (deep scan)
        run: |
          semgrep scan \
            --config=auto \
            --config=p/ci \
            --config=p/secrets \
            --config=p/performance \
            --severity=ERROR

