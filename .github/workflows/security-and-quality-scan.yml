name: Security & Quality Factory Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  factory:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        python -m pip install --upgrade pip
        pip install bandit semgrep flake8 pylint detect-secrets

    # ðŸ¤– DROID â€“ Bandit
    - name: Bandit Security Scan
      run: bandit -r . -f json -o bandit.json || true

    # ðŸ¤– DROID â€“ Semgrep
    - name: Semgrep Scan
      run: semgrep --config=p/ci --json --output semgrep.json || true

    # ðŸ¤– DROID â€“ Flake8
    - name: Flake8 Scan
      run: flake8 --format=json > flake8.json || true

    # ðŸ¤– DROID â€“ Pylint
    - name: Pylint Scan
      run: pylint **/*.py --output-format=json > pylint.json || true

    # ðŸ¤– DROID â€“ Detect Secrets
    - name: Detect Secrets Scan
      run: detect-secrets scan > secrets.json || true

    # ðŸ§  AGGREGATOR â€“ Error Log
    - name: Generate error log
      continue-on-error: true
      run: |
        echo "File (Line) | Issue | Suggested Fix" > error.log
        echo "------------|-------|---------------" >> error.log

        [ -s bandit.json ] && jq -r '.results[] |
          "\(.filename):\(.line_number) | ðŸ”´ Security | Remove hardcoded secret"' bandit.json >> error.log

        [ -s semgrep.json ] && jq -r '.results[] |
          "\(.path):\(.start.line) | ðŸŸ¡ Semgrep | Fix rule \(.check_id)"' semgrep.json >> error.log

        [ -s flake8.json ] && jq -r '.[] |
          "\(.filename):\(.line_number) | ðŸŸ¢ Style | Fix \(.code)"' flake8.json >> error.log

        [ -s pylint.json ] && jq -r '.[] |
          "\(.path):\(.line) | ðŸŸ¢ Pylint | Fix \(.symbol)"' pylint.json >> error.log

        [ -s secrets.json ] && jq -r '.results | to_entries[] |
          "\(.value.filename):\(.value.line_number) | ðŸ”´ Secret | Secure or remove"' secrets.json >> error.log

    - name: Upload error log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-quality-error-log
        path: error.log
